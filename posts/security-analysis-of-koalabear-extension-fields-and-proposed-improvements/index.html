<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Security Analysis of KoalaBear Extension Fields and Proposed Improvements | Sidereus Hu</title>
<meta name="keywords" content="">
<meta name="description" content="1.  Motivation
In a finite cyclic group
$$G = \langle g \rangle, \quad |G| = n$$The discrete logarithm problem (DLP/ECDLP) is formalized as:
**Given $g$ and $y = g^x$, find $x \bmod n$. The secret key $x$ has domain $\mathbb{Z}_n$
Because $g^n = 1$, we have:
$$g^x = g^{x \bmod n}$$This means: The secret key space is at most the size of the group $n$.
The basic attack is to enumerate $x \in {0, \ldots, n-1}$">
<meta name="author" content="Sidereus Hu">
<link rel="canonical" href="https://sidereushu.github.io/posts/security-analysis-of-koalabear-extension-fields-and-proposed-improvements/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.93f625d739f1d6a5c6f20c146bc6a8d26b233492b34b2220c54b12fd46a04ded.css" integrity="sha256-k/Yl1znx1qXG8gwUa8ao0msjNJKzSyIgxUsS/UagTe0=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://sidereushu.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://sidereushu.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://sidereushu.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://sidereushu.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://sidereushu.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://sidereushu.github.io/posts/security-analysis-of-koalabear-extension-fields-and-proposed-improvements/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  
<script>
  MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)'], ['$', '$']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
 


<meta property="og:url" content="https://sidereushu.github.io/posts/security-analysis-of-koalabear-extension-fields-and-proposed-improvements/">
  <meta property="og:site_name" content="Sidereus Hu">
  <meta property="og:title" content="Security Analysis of KoalaBear Extension Fields and Proposed Improvements">
  <meta property="og:description" content="1. Motivation In a finite cyclic group
$$G = \langle g \rangle, \quad |G| = n$$The discrete logarithm problem (DLP/ECDLP) is formalized as:
**Given $g$ and $y = g^x$, find $x \bmod n$. The secret key $x$ has domain $\mathbb{Z}_n$
Because $g^n = 1$, we have:
$$g^x = g^{x \bmod n}$$This means: The secret key space is at most the size of the group $n$.
The basic attack is to enumerate $x \in {0, \ldots, n-1}$">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-28T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-12-28T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Security Analysis of KoalaBear Extension Fields and Proposed Improvements">
<meta name="twitter:description" content="1.  Motivation
In a finite cyclic group
$$G = \langle g \rangle, \quad |G| = n$$The discrete logarithm problem (DLP/ECDLP) is formalized as:
**Given $g$ and $y = g^x$, find $x \bmod n$. The secret key $x$ has domain $\mathbb{Z}_n$
Because $g^n = 1$, we have:
$$g^x = g^{x \bmod n}$$This means: The secret key space is at most the size of the group $n$.
The basic attack is to enumerate $x \in {0, \ldots, n-1}$">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://sidereushu.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Security Analysis of KoalaBear Extension Fields and Proposed Improvements",
      "item": "https://sidereushu.github.io/posts/security-analysis-of-koalabear-extension-fields-and-proposed-improvements/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Security Analysis of KoalaBear Extension Fields and Proposed Improvements",
  "name": "Security Analysis of KoalaBear Extension Fields and Proposed Improvements",
  "description": "1. Motivation In a finite cyclic group\n$$G = \\langle g \\rangle, \\quad |G| = n$$The discrete logarithm problem (DLP/ECDLP) is formalized as:\n**Given $g$ and $y = g^x$, find $x \\bmod n$. The secret key $x$ has domain $\\mathbb{Z}_n$\nBecause $g^n = 1$, we have:\n$$g^x = g^{x \\bmod n}$$This means: The secret key space is at most the size of the group $n$.\nThe basic attack is to enumerate $x \\in {0, \\ldots, n-1}$\n",
  "keywords": [
    
  ],
  "articleBody": "1. Motivation In a finite cyclic group\n$$G = \\langle g \\rangle, \\quad |G| = n$$The discrete logarithm problem (DLP/ECDLP) is formalized as:\n**Given $g$ and $y = g^x$, find $x \\bmod n$. The secret key $x$ has domain $\\mathbb{Z}_n$\nBecause $g^n = 1$, we have:\n$$g^x = g^{x \\bmod n}$$This means: The secret key space is at most the size of the group $n$.\nThe basic attack is to enumerate $x \\in {0, \\ldots, n-1}$\nComplexity is $O(n)$. Therefore:\nIf $n$ is too small, ECDLP is information-theoretically breakable; “Increasing the order $\\Rightarrow$ improving security” is definitively established. All smarter algorithms are essentially “accelerated enumeration”:\nBaby-step-Giant-step: $O(\\sqrt{n})$ time and space Pollard-rho: $O(\\sqrt{n})$ time, constant space 2. Security Argument 0), Basic Parameters and Preliminary Knowledge: Extension degree (Ext): 8 KoalaBear base field $p$ size: $2^{31}$ Extension field size: $(2^{31})^8 = 2^{248}$ Pollard’s rho generic attack complexity: $\\sqrt{2^{248}} = 2^{124}$ Security level: 124 bits 1). Ensure all known specialized attacks are ineffective or inefficient Check Gaudry attack: Complexity $2^{166}$ $$2^{2k(k-1)} \\cdot p^{2-2/k} = 2^{112} \\cdot 2^{31 \\times 1.75} \\approx 2^{112} \\cdot 2^{54.25} \\approx 2^{166.25}$$ Check Joux-Vitse attack: Complexity $2^{180}$ $$(k-1)!(2^{(k-1)(k-2)}e^k k^{-1/2})^\\omega p^2 \\approx 2^{180+}$$ Check MOV attack: Embedding degree is sufficiently high\n2)., Confirm the most effective attack is a generic attack Pollard’s rho generic attack complexity: $2^{124}$ 3). Evaluate whether this complexity is sufficient If higher security is needed, increase the extension degree.. 4). Variant Weil Attack over Quartic Extension Fields Gaudry proposed an index calculus algorithm for the discrete logarithm problem on general abelian varieties of small dimension, and applied this algorithm to the Weil restriction of elliptic curves and hyperelliptic curves over small degree extension fields.\nIn particular, this attack can solve an elliptic curve discrete logarithm problem defined over $\\mathbb{F}_{q^4}$ in heuristic asymptotic running time $\\tilde{O}(q^{4/3})$; and an elliptic problem over $\\mathbb{F}_{q^4}$ or a genus 2 problem over $\\mathbb{F}_{q^2}$ in heuristic asymptotic running time $\\tilde{O}(q^{3/2})$.\nCurrently, there is less effective public literature on attacks for $n=9$. reasons:\nAlgebraic system complexity: If directly using the Semaev summation polynomial method, the number of variables in the multivariate system is $2^{(n-1)} = 256$, with 9 variables to solve, and the Gröbner basis complexity is extremely high and almost infeasible.\n$n=9$ versus $n=8$ (which factors as $2 \\times 4$) has an advantage—namely, the smallest non-trivial subfield is $\\mathbb{F}_{q^3}$ (rather than $\\mathbb{F}_{q^2}$), and $q^3$ is already quite large (93 bits), which increases the difficulty for attackers to construct efficient descent curves. Subfield attack difficulty: Even if descending to $\\mathbb{F}_{q^3}$ (small subfield of size $2^{93}$), the complexity of performing index calculus attacks on this extension field (e.g., assuming descending to a genus $g$ curve) is approximately $\\tilde{O}((q^3)^{(2-2/g)})$.\nFor a relatively small $g$ (e.g., $g=2$), the complexity is approximately $\\tilde{O}((2^{93})^{(1)}) = \\tilde{O}(2^{93})$, below 128 bits; but if $g$ is generally not that small, and the curve obtained after descent is not necessarily a high-efficiency attack target. Recommendations 1). Increase the extension field degree from 8 to 9 (SecLevel: 124 to 139) 2). Adopt TeddyBear (incompatible with Plonky3) 3). Two-layer security model design: proof layer, cryptographic layer 4). Poseidon2 state update issues in the proof layer 5). Todo the security reduced from proof layer (refer: SP1 paper Dec. 2024) ",
  "wordCount" : "533",
  "inLanguage": "zh",
  "datePublished": "2025-12-28T00:00:00Z",
  "dateModified": "2025-12-28T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Sidereus Hu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sidereushu.github.io/posts/security-analysis-of-koalabear-extension-fields-and-proposed-improvements/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Sidereus Hu",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sidereushu.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://sidereushu.github.io/" accesskey="h" title="Sidereus Hu (Alt + H)">Sidereus Hu</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://sidereushu.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://sidereushu.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Security Analysis of KoalaBear Extension Fields and Proposed Improvements
    </h1>
    <div class="post-meta"><span title='2025-12-28 00:00:00 +0000 UTC'>2025-12-28</span>&nbsp;·&nbsp;Sidereus Hu

</div>
  </header> 
  <div class="post-content"><h2 id="1--motivation">1.  Motivation<a hidden class="anchor" aria-hidden="true" href="#1--motivation">#</a></h2>
<p>In a finite cyclic group</p>
$$G = \langle g \rangle, \quad |G| = n$$<p>The discrete logarithm problem (DLP/ECDLP) is formalized as:</p>
<p>**Given $g$ and $y = g^x$, find $x \bmod n$. The secret key $x$ has domain $\mathbb{Z}_n$</p>
<p>Because $g^n = 1$, we have:</p>
$$g^x = g^{x \bmod n}$$<p>This means: The secret key space is at most the size of the group $n$.</p>
<p>The basic attack is to enumerate $x \in {0, \ldots, n-1}$</p>
<p>Complexity is $O(n)$. Therefore:</p>
<ul>
<li>If $n$ is too small, ECDLP is information-theoretically breakable;</li>
<li>&ldquo;<strong>Increasing the order</strong> $\Rightarrow$ <strong>improving security</strong>&rdquo; is definitively established.</li>
</ul>
<p>All smarter algorithms are essentially &ldquo;accelerated enumeration&rdquo;:</p>
<ul>
<li>Baby-step-Giant-step: $O(\sqrt{n})$ time and space</li>
<li>Pollard-rho: $O(\sqrt{n})$ time, constant space</li>
</ul>
<h2 id="2--security-argument">2.  Security Argument<a hidden class="anchor" aria-hidden="true" href="#2--security-argument">#</a></h2>
<p><img loading="lazy" src="/images/koala8.png"></p>
<h3 id="0-basic-parameters-and-preliminary-knowledge">0), Basic Parameters and Preliminary Knowledge:<a hidden class="anchor" aria-hidden="true" href="#0-basic-parameters-and-preliminary-knowledge">#</a></h3>
<ul>
<li><strong>Extension degree (Ext)</strong>: 8</li>
<li><strong>KoalaBear base field $p$ size</strong>: $2^{31}$</li>
<li><strong>Extension field size</strong>: $(2^{31})^8 = 2^{248}$</li>
<li><strong>Pollard&rsquo;s rho generic attack complexity</strong>: $\sqrt{2^{248}} = 2^{124}$</li>
<li><strong>Security level</strong>: 124 bits</li>
</ul>
<h3 id="1-ensure-all-known-specialized-attacks-are-ineffective-or-inefficient">1). Ensure all known specialized attacks are ineffective or inefficient<a hidden class="anchor" aria-hidden="true" href="#1-ensure-all-known-specialized-attacks-are-ineffective-or-inefficient">#</a></h3>
<ul>
<li>
<p><strong>Check Gaudry attack</strong>: Complexity $2^{166}$
</p>
$$2^{2k(k-1)} \cdot p^{2-2/k} = 2^{112} \cdot 2^{31 \times 1.75} \approx 2^{112} \cdot 2^{54.25} \approx 2^{166.25}$$</li>
<li>
<p><strong>Check Joux-Vitse attack</strong>: Complexity $2^{180}$
</p>
$$(k-1)!(2^{(k-1)(k-2)}e^k k^{-1/2})^\omega p^2 \approx 2^{180+}$$</li>
<li>
<p><strong>Check MOV attack</strong>: Embedding degree is sufficiently high</p>
</li>
</ul>
<h3 id="2-confirm-the-most-effective-attack-is-a-generic-attack">2)., Confirm the most effective attack is a generic attack<a hidden class="anchor" aria-hidden="true" href="#2-confirm-the-most-effective-attack-is-a-generic-attack">#</a></h3>
<ul>
<li><strong>Pollard&rsquo;s rho generic attack complexity</strong>: $2^{124}$</li>
</ul>
<h3 id="3--evaluate-whether-this-complexity-is-sufficient">3).  Evaluate whether this complexity is sufficient<a hidden class="anchor" aria-hidden="true" href="#3--evaluate-whether-this-complexity-is-sufficient">#</a></h3>
<ul>
<li>If higher security is needed, increase the extension degree..</li>
</ul>
<h3 id="4-variant-weil-attack-over-quartic-extension-fields">4). Variant Weil Attack over Quartic Extension Fields<a hidden class="anchor" aria-hidden="true" href="#4-variant-weil-attack-over-quartic-extension-fields">#</a></h3>
<p>Gaudry proposed an index calculus algorithm for the discrete logarithm problem on general abelian varieties of small dimension, and applied this algorithm to the <strong>Weil restriction</strong> of elliptic curves and hyperelliptic curves over small degree extension fields.</p>
<p>In particular, this attack can solve an elliptic curve discrete logarithm problem defined over $\mathbb{F}_{q^4}$ in heuristic asymptotic running time $\tilde{O}(q^{4/3})$; and an elliptic problem over $\mathbb{F}_{q^4}$ or a <strong>genus 2 problem</strong> over $\mathbb{F}_{q^2}$ in heuristic asymptotic running time $\tilde{O}(q^{3/2})$.</p>
<ul>
<li>
<p>Currently, there is less effective public literature on attacks for $n=9$.  reasons:</p>
<ul>
<li>
<p><strong>Algebraic system complexity</strong>: If directly using the Semaev summation polynomial method, the number of variables in the multivariate system is $2^{(n-1)} = 256$, with 9 variables to solve, and the <strong>Gröbner basis complexity is extremely high</strong> and almost infeasible.</p>
<ul>
<li>$n=9$ versus $n=8$ (which factors as $2 \times 4$) has an advantage—namely, the smallest non-trivial subfield is $\mathbb{F}_{q^3}$ (rather than $\mathbb{F}_{q^2}$), and $q^3$ is already quite large (93 bits), which increases the difficulty for attackers to construct efficient descent curves.</li>
</ul>
</li>
<li>
<p><strong>Subfield attack difficulty</strong>: Even if descending to $\mathbb{F}_{q^3}$ (small subfield of size $2^{93}$), the complexity of performing index calculus attacks on this extension field (e.g., assuming descending to a genus $g$ curve) is approximately $\tilde{O}((q^3)^{(2-2/g)})$.</p>
<ul>
<li>For a relatively small $g$ (e.g., $g=2$), the complexity is approximately $\tilde{O}((2^{93})^{(1)}) = \tilde{O}(2^{93})$, below 128 bits; but if $g$ is generally not that small, and the curve obtained after descent is not necessarily a high-efficiency attack target.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="recommendations">Recommendations<a hidden class="anchor" aria-hidden="true" href="#recommendations">#</a></h2>
<p><img loading="lazy" src="/images/KoalarPoseidon.png"></p>
<h4 id="1--increase-the-extension-field-degree-from-8-to-9-seclevel-124-to-139">1).  Increase the extension field degree from 8 to 9 (SecLevel: 124 to 139)<a hidden class="anchor" aria-hidden="true" href="#1--increase-the-extension-field-degree-from-8-to-9-seclevel-124-to-139">#</a></h4>
<h4 id="2--adopt-teddybear-incompatible-with-plonky3">2).  Adopt TeddyBear (incompatible with Plonky3)<a hidden class="anchor" aria-hidden="true" href="#2--adopt-teddybear-incompatible-with-plonky3">#</a></h4>
<h4 id="3--two-layer-security-model-design-proof-layer-cryptographic-layer">3).  Two-layer security model design: proof layer, cryptographic layer<a hidden class="anchor" aria-hidden="true" href="#3--two-layer-security-model-design-proof-layer-cryptographic-layer">#</a></h4>
<h4 id="4--poseidon2-state-update-issues-in-the-proof-layer">4).  Poseidon2 state update issues in the proof layer<a hidden class="anchor" aria-hidden="true" href="#4--poseidon2-state-update-issues-in-the-proof-layer">#</a></h4>
<h4 id="5--todo-the-security-reduced-from-proof-layer-refer-sp1-paper-dec-2024">5).  Todo the security reduced from proof layer (refer: SP1 paper Dec. 2024)<a hidden class="anchor" aria-hidden="true" href="#5--todo-the-security-reduced-from-proof-layer-refer-sp1-paper-dec-2024">#</a></h4>
<p><img loading="lazy" src="/images/SP1DEC24.png"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://sidereushu.github.io/">Sidereus Hu</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
